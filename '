<script lang="ts">
	import { invoke } from "@tauri-apps/api/tauri";
	import { convertFileSrc } from "@tauri-apps/api/tauri";
	import { onMount } from "svelte";
	import { open } from "@tauri-apps/api/dialog";
	import { readBinaryFile } from "@tauri-apps/api/fs";

	export let game: Game;

	let loading = true;
	let iconUrl: string, backgroundUrl: string;

	onMount(async () => {
		iconUrl = game.icon.length > 0 ? convertFileSrc(game.icon) : "";
		backgroundUrl =
			game.background.length > 0 ? convertFileSrc(game.background) : "";
		loading = false;
	});

	$: console.log("Refresh", game);

	enum ImageType {
		Icon = 1,
		Background,
	}

	async function imageToArray(img: File): Promise<number[]> {
		const buffer = await img.arrayBuffer();
		const imageArray = Array.from(new Uint8Array(buffer));
		return imageArray;
	}

	// async function handleIconUpload(e: Event) {
	// 	const input = e.target as HTMLInputElement;
	// 	const imageArray = await imageToArray(input.files[0]);
	// 	const imgPath = (await invoke("save_image", {
	// 		image: imageArray,
	// 		id: game.id,
	// 		imageType: ImageType.Icon,
	// 		oldPath: game.icon,
	// 	})) as string;
	//
	// 	iconUrl = convertFileSrc(imgPath);
	//
	// 	game.icon = imgPath;
	// 	game = game;
	// }

	async function handleIconUpload() {
		const dialog = (await open({
			multiple: false,
			filters: [
				{ extensions: ["png", "jpeg", "jpg", "gif", "ico"], name: "images" },
			],
		})) as string | null;
		if (dialog == null) return;

		const imgArray = Array.from(await readBinaryFile(dialog));
		const imgPath = (await invoke("save_image", {
			image: imgArray,
			id: game.id,
			imageType: ImageType.Icon,
			oldPath: game.icon,
		})) as string;

		iconUrl = convertFileSrc(imgPath);

		game.icon = imgPath;
		game = game;
	}

	async function handleBackgroundUpload(e: Event) {
		const dialog = (await open({
			multiple: false,
			filters: [
				{ extensions: ["png", "jpeg", "jpg", "gif", "ico"], name: "images" },
			],
		})) as string | null;
		if (dialog == null) return;

		const imgArray = Array.from(await readBinaryFile(dialog));
		const imgPath = (await invoke("save_image", {
			image: imgArray,
			id: game.id,
			imageType: ImageType.Background,
			oldPath: game.background,
		}).catch((err) => console.error(err))) as string;

		backgroundUrl = convertFileSrc(imgPath);

		game.background = imgPath;
		game = game;
	}

	async function handlePath() {
		const dialog = (await open({
			multiple: false,
			filters: [{ extensions: ["exe", "app", "msi"], name: "Executables" }],
		})) as string | null;

		if (dialog == null) return;

		game.path = dialog;
		game = game;
	}
</script>

<div
	class="bg-slate-900 px-5 py-4 flex gap-4 justify-center items-center rounded-lg"
>
	{#if !loading}
		<div class="flex flex-col gap-4">
			<div class="flex items-center gap-2">
				<h6 class="text-gray-300 tracking-wide">Title</h6>
				<input
					bind:value={game.title}
					class="text-white text-lg bg-gray-800 p-2 rounded border-slate-700 border-2 outline-none focus:border-white"
				/>
			</div>
			<div class="flex items-start gap-2">
				<h6 class="text-gray-300 tracking-wide">Icon</h6>
				<button
					class=" relative cursor-pointer group border-2 border-slate-700 rounded p-2 w-32 h-32 gap-1 flex flex-col items-center justify-center"
					on:click={handleIconUpload}
				>
					{#if iconUrl.length > 0}
						<img
							src={iconUrl}
							alt="{game.title}-icon"
							class="object-contain group-hover:opacity-20"
						/>
					{:else}
						<svg
							fill="white"
							viewBox="0 0 24 24"
							xmlns="http://www.w3.org/2000/svg"
							aria-hidden="true"
							class="group-hover:opacity-20 w-16 m-0"
						>
							<path
								clip-rule="evenodd"
								fill-rule="evenodd"
								d="M5.625 1.5H9a3.75 3.75 0 013.75 3.75v1.875c0 1.036.84 1.875 1.875 1.875H16.5a3.75 3.75 0 013.75 3.75v7.875c0 1.035-.84 1.875-1.875 1.875H5.625a1.875 1.875 0 01-1.875-1.875V3.375c0-1.036.84-1.875 1.875-1.875zm6.905 9.97a.75.75 0 00-1.06 0l-3 3a.75.75 0 101.06 1.06l1.72-1.72V18a.75.75 0 001.5 0v-4.19l1.72 1.72a.75.75 0 101.06-1.06l-3-3z"
							/>
							<path
								d="M14.25 5.25a5.23 5.23 0 00-1.279-3.434 9.768 9.768 0 016.963 6.963A5.23 5.23 0 0016.5 7.5h-1.875a.375.375 0 01-.375-.375V5.25z"
							/>
						</svg>
						<p class="text-white text-xs text-center group-hover:opacity-40">
							Upload icon
						</p>
					{/if}
					<svg
						fill="white"
						viewBox="0 0 24 24"
						xmlns="http://www.w3.org/2000/svg"
						aria-hidden="true"
						class="hidden group-hover:block absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12"
					>
						<path
							clip-rule="evenodd"
							fill-rule="evenodd"
							d="M11.47 2.47a.75.75 0 011.06 0l4.5 4.5a.75.75 0 01-1.06 1.06l-3.22-3.22V16.5a.75.75 0 01-1.5 0V4.81L8.03 8.03a.75.75 0 01-1.06-1.06l4.5-4.5zM3 15.75a.75.75 0 01.75.75v2.25a1.5 1.5 0 001.5 1.5h13.5a1.5 1.5 0 001.5-1.5V16.5a.75.75 0 011.5 0v2.25a3 3 0 01-3 3H5.25a3 3 0 01-3-3V16.5a.75.75 0 01.75-.75z"
						/>
					</svg>
				</button>
			</div>
			<div class="flex items-center gap-2">
				<h6 class="text-gray-300 tracking-wide">Path</h6>
				<button
					class="text-white text-sm bg-gray-600 hover:bg-gray-700 p-2 rounded border-slate-700 border-2 outline-none focus:border-white"
					on:click={handlePath}
				>
					{game.path.length > 0 ? game.path.slice(-32) : "Choose game file"}
				</button>
			</div>
		</div>
		<div class="w-full">
			<label
				class="relative cursor-pointer flex justify-center items-center flex-col border-2 border-gray-800 border-dashed group h-[240px]"
			>
				{#if game.background.length != 0}
					<img
						src={backgroundUrl}
						alt="{game.title}-icon"
						class="object-cover h-full w-full group-hover:brightness-50"
					/>
					<svg
						xmlns="http://www.w3.org/2000/svg"
						viewBox="0 0 24 24"
						class="hidden group-hover:block absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12"
					>
						<path
							d="M4 19H20V12H22V20C22 20.5523 21.5523 21 21 21H3C2.44772 21 2 20.5523 2 20V12H4V19ZM14 9V15H10V9H5L12 2L19 9H14Z"
							fill="rgba(255,255,255,1)"
						/>
					</svg>
				{:else}
					<svg
						xmlns="http://www.w3.org/2000/svg"
						viewBox="0 0 24 24"
						class="w-12 mt-4 group-hover:opacity-40"
						><path
							d="M16 2L21 7V21.0082C21 21.556 20.5551 22 20.0066 22H3.9934C3.44476 22 3 21.5447 3 21.0082V2.9918C3 2.44405 3.44495 2 3.9934 2H16ZM13 12H16L12 8L8 12H11V16H13V12Z"
							fill="white"
						/></svg
					>
					<span
						class="text-white text-sm font-light mb-4 group-hover:opacity-40"
					>
						Upload background
					</span>
				{/if}
				<input
					type="file"
					accept="image/png, image/jpeg"
					class="absolute top-0 left-0 w-full h-full hidden"
					on:change={handleBackgroundUpload}
				/>
			</label>
		</div>
	{/if}
</div>
